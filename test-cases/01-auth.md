# è®¤è¯æ¨¡å—æµ‹è¯•ç”¨ä¾‹

> Auth Module - ç™»å½•ã€Tokenã€æƒé™éªŒè¯

---

## æ¨¡å—æ¦‚è§ˆ

| å±æ€§ | å€¼ |
|-----|---|
| æ¨¡å— | è®¤è¯æ¨¡å— (auth) |
| æ–‡ä»¶ | `apps/api/src/modules/auth/` |
| æ ¸å¿ƒåŠŸèƒ½ | ç™»å½•éªŒè¯ã€Tokenç­¾å‘ã€ç”¨æˆ·ä¿¡æ¯è·å– |
| æµ‹è¯•ç”¨ä¾‹æ•° | 32 |
| ä¼˜å…ˆçº§åˆ†å¸ƒ | P0: 12, P1: 12, P2: 8 |

---

## 1. åŠŸèƒ½è·¯å¾„æµ‹è¯• (Functional)

### 1.1 æ­£å¸¸æµç¨‹ (Happy Path)

| ID | åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º | ä¼˜å…ˆçº§ |
|----|------|------|---------|--------|
| AUTH-F-01 | æ ‡å‡†ç™»å½•æˆåŠŸ | æœ‰æ•ˆç”¨æˆ·å/å¯†ç  | è¿”å› access_token å’Œç”¨æˆ·ä¿¡æ¯ | P0 |
| AUTH-F-02 | ç™»å½•åè·å–ç”¨æˆ·ä¿¡æ¯ | æœ‰æ•ˆ JWT Token | è¿”å›ç”¨æˆ·è¯¦æƒ…å’Œæƒé™åˆ—è¡¨ | P0 |
| AUTH-F-03 | Token åˆ·æ–° | æœ‰æ•ˆ JWT Token | è¿”å›æ–°çš„ access_token | P1 |
| AUTH-F-04 | é€€å‡ºç™»å½• | æœ‰æ•ˆ JWT Token | è¿”å›é€€å‡ºæˆåŠŸæ¶ˆæ¯ | P1 |
| AUTH-F-05 | æ›´æ–°æœ€åç™»å½•æ—¶é—´ | æˆåŠŸç™»å½•å | æ•°æ®åº“ lastLoginAt å­—æ®µæ›´æ–° | P1 |
| AUTH-F-06 | ç™»å½•æ—¥å¿—è®°å½• | æˆåŠŸç™»å½• | åˆ›å»ºç™»å½•æˆåŠŸæ—¥å¿—è®°å½• | P2 |

**æµ‹è¯•ä»£ç ç¤ºä¾‹:**
```typescript
// AUTH-F-01: æ ‡å‡†ç™»å½•æˆåŠŸ
describe('login', () => {
  it('should return access token and user info for valid credentials', async () => {
    const result = await authService.login(mockUser);
    expect(result).toHaveProperty('access_token');
    expect(result).toHaveProperty('user');
    expect(result.user).not.toHaveProperty('passwordHash');
  });
});
```

### 1.2 å¼‚å¸¸æµç¨‹ (Error Path)

| ID | åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º | ä¼˜å…ˆçº§ |
|----|------|------|---------|--------|
| AUTH-F-07 | ç”¨æˆ·åä¸å­˜åœ¨ | ä¸å­˜åœ¨çš„ç”¨æˆ·å | è¿”å› 401 æœªæˆæƒé”™è¯¯ | P0 |
| AUTH-F-08 | å¯†ç é”™è¯¯ | é”™è¯¯çš„å¯†ç  | è¿”å› 401 æœªæˆæƒé”™è¯¯ | P0 |
| AUTH-F-09 | ç”¨æˆ·å·²ç¦ç”¨ | status=0 çš„ç”¨æˆ· | è¿”å› 401 æœªæˆæƒé”™è¯¯ | P0 |
| AUTH-F-10 | Token è¿‡æœŸ | è¿‡æœŸ JWT Token | è¿”å› 401 éœ€è¦é‡æ–°ç™»å½• | P0 |
| AUTH-F-11 | æ— æ•ˆ Token æ ¼å¼ | æ ¼å¼é”™è¯¯çš„ Token | è¿”å› 401 æœªæˆæƒé”™è¯¯ | P1 |
| AUTH-F-12 | ç©º Token è¯·æ±‚ | æ—  Authorization å¤´ | è¿”å› 401 æœªæˆæƒé”™è¯¯ | P0 |

**æ³¨æ„äº‹é¡¹:**
- AUTH-F-07/08 çš„é”™è¯¯æç¤ºåº”è¯¥ç›¸åŒï¼Œé¿å…ç”¨æˆ·åæšä¸¾æ”»å‡»
- è¿”å›ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼š"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

---

## 2. è¾¹ç•Œå€¼æµ‹è¯• (Boundary)

### 2.1 ç”¨æˆ·åè¾¹ç•Œ

| ID | åœºæ™¯ | è¾“å…¥å€¼ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|----|------|-------|---------|--------|
| AUTH-B-01 | ç”¨æˆ·å-ç©ºå­—ç¬¦ä¸² | `""` | 400 å‚æ•°é”™è¯¯ | P0 |
| AUTH-B-02 | ç”¨æˆ·å-æœ€å°é•¿åº¦ | `"a"` | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P1 |
| AUTH-B-03 | ç”¨æˆ·å-æœ€å¤§é•¿åº¦ | `"a" * 50` | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P1 |
| AUTH-B-04 | ç”¨æˆ·å-è¶…é•¿ | `"a" * 1000` | 400 å‚æ•°é”™è¯¯æˆ–æ­£å¸¸æˆªæ–­ | P2 |
| AUTH-B-05 | ç”¨æˆ·å-ç‰¹æ®Šå­—ç¬¦ | `"user@#$%"` | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P1 |
| AUTH-B-06 | ç”¨æˆ·å-Unicode | `"ç”¨æˆ·ğŸ‰"` | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P2 |
| AUTH-B-07 | ç”¨æˆ·å-ä»…ç©ºç™½å­—ç¬¦ | `"   "` | 400 å‚æ•°é”™è¯¯ | P1 |

### 2.2 å¯†ç è¾¹ç•Œ

| ID | åœºæ™¯ | è¾“å…¥å€¼ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|----|------|-------|---------|--------|
| AUTH-B-10 | å¯†ç -ç©ºå­—ç¬¦ä¸² | `""` | 400 å‚æ•°é”™è¯¯ | P0 |
| AUTH-B-11 | å¯†ç -æœ€å°é•¿åº¦ | `"123456"` (6ä½) | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P1 |
| AUTH-B-12 | å¯†ç -æœ€å¤§é•¿åº¦ | 128ä½å­—ç¬¦ | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P1 |
| AUTH-B-13 | å¯†ç -è¶…é•¿ | 1000ä½å­—ç¬¦ | 400 å‚æ•°é”™è¯¯ | P2 |
| AUTH-B-14 | å¯†ç -ç‰¹æ®Šå­—ç¬¦ | `"p@ssw0rd!"` | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P1 |
| AUTH-B-15 | å¯†ç -Unicode | `"å¯†ç ğŸ‰123"` | æŒ‰æ­£å¸¸é€»è¾‘å¤„ç† | P2 |

### 2.3 Token è¾¹ç•Œ

| ID | åœºæ™¯ | è¾“å…¥å€¼ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|----|------|-------|---------|--------|
| AUTH-B-20 | Token-ç©º | `""` | 401 æœªæˆæƒ | P0 |
| AUTH-B-21 | Token-æ ¼å¼é”™è¯¯ | `"invalid-token"` | 401 æœªæˆæƒ | P0 |
| AUTH-B-22 | Token-ç¼ºå°‘Bearer | `"eyJhbG..."` | 401 æœªæˆæƒ | P1 |
| AUTH-B-23 | Token-è¿‡æœŸæ—¶é—´è¾¹ç•Œ | åˆšå¥½è¿‡æœŸ | 401 æœªæˆæƒ | P1 |

---

## 3. å¼‚å¸¸æµ‹è¯• (Exception)

### 3.1 è¾“å…¥å¼‚å¸¸

| ID | åœºæ™¯ | é”™è¯¯è¾“å…¥ | é¢„æœŸè¡Œä¸º | ä¼˜å…ˆçº§ |
|----|------|---------|---------|--------|
| AUTH-E-01 | null ç”¨æˆ·å | `{ username: null }` | 400 å‚æ•°æ ¡éªŒå¤±è´¥ | P0 |
| AUTH-E-02 | undefined ç”¨æˆ·å | `{ username: undefined }` | 400 å‚æ•°æ ¡éªŒå¤±è´¥ | P0 |
| AUTH-E-03 | æ•°å­—ç±»å‹ç”¨æˆ·å | `{ username: 123 }` | 400 ç±»å‹é”™è¯¯ | P1 |
| AUTH-E-04 | æ•°ç»„ç±»å‹ç”¨æˆ·å | `{ username: ["a"] }` | 400 ç±»å‹é”™è¯¯ | P1 |
| AUTH-E-05 | å¯¹è±¡ç±»å‹ç”¨æˆ·å | `{ username: {} }` | 400 ç±»å‹é”™è¯¯ | P1 |
| AUTH-E-06 | null å¯†ç  | `{ password: null }` | 400 å‚æ•°æ ¡éªŒå¤±è´¥ | P0 |
| AUTH-E-07 | ç¼ºå¤±ç”¨æˆ·åå­—æ®µ | `{ password: "123" }` | 400 å¿…å¡«æ ¡éªŒå¤±è´¥ | P0 |
| AUTH-E-08 | ç¼ºå¤±å¯†ç å­—æ®µ | `{ username: "admin" }` | 400 å¿…å¡«æ ¡éªŒå¤±è´¥ | P0 |
| AUTH-E-09 | ç©ºå¯¹è±¡è¯·æ±‚ | `{}` | 400 å¿…å¡«æ ¡éªŒå¤±è´¥ | P0 |

### 3.2 ä¾èµ–å¼‚å¸¸

| ID | åœºæ™¯ | æ¨¡æ‹Ÿæ¡ä»¶ | é¢„æœŸè¡Œä¸º | ä¼˜å…ˆçº§ |
|----|------|---------|---------|--------|
| AUTH-E-20 | æ•°æ®åº“è¿æ¥è¶…æ—¶ | Prisma è¿æ¥è¶…æ—¶ | 500 æœåŠ¡å™¨é”™è¯¯ | P1 |
| AUTH-E-21 | æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ | Prisma æŠ›å‡ºå¼‚å¸¸ | 500 æœåŠ¡å™¨é”™è¯¯ | P1 |
| AUTH-E-22 | JWT ç­¾åå¤±è´¥ | JwtService å¼‚å¸¸ | 500 æœåŠ¡å™¨é”™è¯¯ | P2 |
| AUTH-E-23 | Redis è¿æ¥å¤±è´¥ | ç¼“å­˜æœåŠ¡å¼‚å¸¸ | æ­£å¸¸ç™»å½•ï¼ˆé™çº§ï¼‰ | P2 |

### 3.3 å¹¶å‘å¼‚å¸¸

| ID | åœºæ™¯ | æµ‹è¯•æ–¹æ³• | é¢„æœŸè¡Œä¸º | ä¼˜å…ˆçº§ |
|----|------|---------|---------|--------|
| AUTH-E-30 | é‡å¤ç™»å½•è¯·æ±‚ | åŒæ—¶å‘é€2ä¸ªç›¸åŒè¯·æ±‚ | éƒ½è¿”å›æ­£å¸¸ç»“æœï¼ˆå¹‚ç­‰ï¼‰ | P1 |
| AUTH-E-31 | æš´åŠ›ç ´è§£å°è¯• | 100æ¬¡é”™è¯¯å¯†ç  | è´¦å·é”å®šæˆ–éªŒè¯ç  | P2 |
| AUTH-E-32 | é«˜å¹¶å‘ç™»å½• | 1000å¹¶å‘ç™»å½•è¯·æ±‚ | ç³»ç»Ÿç¨³å®šï¼Œå“åº”æ­£å¸¸ | P2 |

**æµ‹è¯•ä»£ç ç¤ºä¾‹:**
```typescript
// AUTH-E-20: æ•°æ®åº“è¿æ¥è¶…æ—¶
describe('database errors', () => {
  it('should handle database timeout', async () => {
    jest.spyOn(prisma.user, 'findUnique').mockRejectedValue(
      new Error('Connection timeout')
    );
    await expect(
      authService.validateUser('admin', 'password')
    ).rejects.toThrow();
  });
});
```

---

## 4. æ€§èƒ½æµ‹è¯• (Performance)

| ID | åœºæ™¯ | æµ‹è¯•æ¡ä»¶ | é¢„æœŸæŒ‡æ ‡ | ä¼˜å…ˆçº§ |
|----|------|---------|---------|--------|
| AUTH-P-01 | ç™»å½•å“åº”æ—¶é—´ | å•ç”¨æˆ·æ ‡å‡†ç™»å½• | < 200ms | P1 |
| AUTH-P-02 | è·å–ç”¨æˆ·ä¿¡æ¯ | Token éªŒè¯+æŸ¥è¯¢ | < 100ms | P1 |
| AUTH-P-03 | Token åˆ·æ–° | éªŒè¯+ç­¾å‘æ–°Token | < 100ms | P1 |
| AUTH-P-04 | å¹¶å‘ç™»å½• | 100å¹¶å‘ | æˆåŠŸç‡>99%ï¼Œå¹³å‡<500ms | P2 |
| AUTH-P-05 | æ•°æ®åº“å‹åŠ› | æŒç»­ç™»å½•1å°æ—¶ | æ— è¿æ¥æ³„æ¼ | P2 |

**æ€§èƒ½æµ‹è¯•ä»£ç :**
```typescript
// AUTH-P-01: ç™»å½•å“åº”æ—¶é—´
describe('performance', () => {
  it('should complete login within 200ms', async () => {
    const start = Date.now();
    await authService.login(mockUser);
    const duration = Date.now() - start;
    expect(duration).toBeLessThan(200);
  });
});
```

---

## 5. å®‰å…¨æµ‹è¯• (Security)

| ID | åœºæ™¯ | æµ‹è¯•è¾“å…¥ | é¢„æœŸé˜²æŠ¤ | ä¼˜å…ˆçº§ |
|----|------|---------|---------|--------|
| AUTH-S-01 | SQL æ³¨å…¥-ç”¨æˆ·å | `"' OR '1'='1"` | å‚æ•°åŒ–æŸ¥è¯¢ï¼Œæ‹’ç»ç™»å½• | P0 |
| AUTH-S-02 | SQL æ³¨å…¥-å¯†ç  | `"' OR '1'='1"` | å¯†ç å“ˆå¸Œæ¯”è¾ƒï¼Œæ‹’ç»ç™»å½• | P0 |
| AUTH-S-03 | NoSQL æ³¨å…¥ | `{ "$gt": "" }` | ç±»å‹æ ¡éªŒï¼Œæ‹’ç»è¯·æ±‚ | P1 |
| AUTH-S-04 | XSS å°è¯•-ç”¨æˆ·å | `"<script>alert('xss')</script>"` | åŸæ ·å­˜å‚¨ï¼Œä¸æ‰§è¡Œ | P1 |
| AUTH-S-05 | æš´åŠ›ç ´è§£é˜²æŠ¤ | è¿ç»­10æ¬¡é”™è¯¯ | è´¦å·é”å®šæˆ–éªŒè¯ç  | P1 |
| AUTH-S-06 | Token ä¼ªé€  | ä¿®æ”¹ JWT payload | ç­¾åéªŒè¯å¤±è´¥ï¼Œ401 | P0 |
| AUTH-S-07 | Token é‡æ”¾ | ä½¿ç”¨å·²æ³¨é”€çš„Token | Token é»‘åå•æ£€æŸ¥ | P2 |
| AUTH-S-08 | æ•æ„Ÿä¿¡æ¯æ³„éœ² | é”™è¯¯å“åº” | ä¸è¿”å›å…·ä½“å­—æ®µé”™è¯¯ | P1 |

**å…³é”®å®‰å…¨æ£€æŸ¥ç‚¹:**

```typescript
// AUTH-S-01: SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•
it('should prevent SQL injection in username', async () => {
  const maliciousUsername = "' OR '1'='1";
  jest.spyOn(prisma.user, 'findUnique').mockResolvedValue(null);
  
  const result = await authService.validateUser(maliciousUsername, 'password');
  expect(result).toBeNull();
  expect(prisma.user.findUnique).toHaveBeenCalledWith({
    where: { username: maliciousUsername },  // åŸæ ·ä¼ å…¥ï¼Œå‚æ•°åŒ–æŸ¥è¯¢
    include: { role: true },
  });
});

// AUTH-S-06: Tokenä¼ªé€ æ£€æµ‹
it('should reject forged token', async () => {
  const forgedToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.for.payload';
  // JWT ç­¾åéªŒè¯åº”å¤±è´¥
});
```

---

## 6. æµ‹è¯•æ•°æ®å‡†å¤‡

### 6.1 Mock ç”¨æˆ·æ•°æ®

```typescript
export const mockUsers = {
  admin: {
    id: 'admin-id',
    username: 'admin',
    passwordHash: '$2a$10$...',  // bcrypt hash of 'admin123'
    status: 1,
    role: { code: 'super_admin' },
  },
  disabled: {
    id: 'disabled-id',
    username: 'disabled',
    passwordHash: '$2a$10$...',
    status: 0,
    role: { code: 'user' },
  },
};
```

### 6.2 æµ‹è¯•ç¯å¢ƒé…ç½®

```typescript
// æµ‹è¯•æ¨¡å—é…ç½®
const module: TestingModule = await Test.createTestingModule({
  providers: [
    AuthService,
    {
      provide: PrismaClient,
      useValue: mockPrisma,
    },
    {
      provide: JwtService,
      useValue: {
        sign: jest.fn().mockReturnValue('mock-jwt-token'),
        verify: jest.fn(),
      },
    },
  ],
}).compile();
```

---

## 7. æ‰§è¡Œæ¸…å•

### P0 å¿…æµ‹é¡¹ï¼ˆ12ä¸ªï¼‰

- [ ] AUTH-F-01 æ ‡å‡†ç™»å½•æˆåŠŸ
- [ ] AUTH-F-02 è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] AUTH-F-07 ç”¨æˆ·åä¸å­˜åœ¨
- [ ] AUTH-F-08 å¯†ç é”™è¯¯
- [ ] AUTH-F-09 ç”¨æˆ·å·²ç¦ç”¨
- [ ] AUTH-F-10 Tokenè¿‡æœŸ
- [ ] AUTH-F-12 ç©ºTokenè¯·æ±‚
- [ ] AUTH-B-01 ç”¨æˆ·åç©ºå­—ç¬¦ä¸²
- [ ] AUTH-B-10 å¯†ç ç©ºå­—ç¬¦ä¸²
- [ ] AUTH-E-01 nullç”¨æˆ·å
- [ ] AUTH-S-01 SQLæ³¨å…¥é˜²æŠ¤
- [ ] AUTH-S-06 Tokenä¼ªé€ æ£€æµ‹

### å·²æœ‰æµ‹è¯•è¦†ç›–æ£€æŸ¥

å·²æœ‰æµ‹è¯•æ–‡ä»¶: `apps/api/test/unit/auth/auth.service.spec.ts`

| ç”¨ä¾‹ID | å·²è¦†ç›– | éœ€è¡¥å…… |
|-------|-------|-------|
| AUTH-F-01 | âœ… | - |
| AUTH-F-07~09 | âœ… | - |
| AUTH-E-01~09 | âš ï¸ | éƒ¨åˆ†ç±»å‹æµ‹è¯• |
| AUTH-S-01~08 | âŒ | éœ€è¡¥å……å®‰å…¨æµ‹è¯• |

---

*æ–‡æ¡£ç»“æŸ - è®¤è¯æ¨¡å—å…±32ä¸ªæµ‹è¯•ç”¨ä¾‹*
